bat - т.к. Windows на целевом сервере
Скрипты, предваряющие перенос базы на pg11.
Основная цель - уменьшить объем для быстрого перевода продакшена в дальнейшем +
сохранить удаляемые данные в plain чтобы можно было загрузить в pg11 при необходимости
(как практика показала, архивы 2020 понадобились - были успешно восстановлены)




Последовательность операций
0) делаем предварительно дампы работающих баз - (lanmon_restored  и archives_restored) - 
00) на диске, где есть свободное место создаем папку (например - f:\lm\), копируем туда bat-файлы. Запускаем из 
	cmd: пример первой команды - "C:\Program Files\PostgreSQL\12\bin>f:\lm\1_dump_logs"
1) 1_dump_log.bat - резервное копирование данных таблиц public.logs_20xx_xx базы lanmon.
	можно запустить на работающей базе, последить за производительностью 
	(ориентир - 3 минуты, кратность превышения можно в дальнейшем использовать для оценки времени других операций)
	в скрипте предварительно проконтролировать названия сервера, базы, порт
2) 2_dump_log2.bat - резервное копирование данных таблиц lanmon2.logs2_20xx_xx базы lanmon.
	если с первым пунктом все норм - запускаем на работающей базе (ориентир - 8 минут)
3) 3_dump_data - выполняем на остановленном сервере (lanmon), проверяем на трехлетнем периоде. Ориентир со стенда: (ставим (2009,1,2010) - 2 минуты (2009,1,2018) - 35 минут)
4) шаги 1,2,3 по данным дублируют 0), являются желательными  
убеждаемся, что все дампы (0) нормально восстанавливаются на нашем сервере

5) ставим PostgreSQL11 порт 5433, конфигурируем - pg_stat_statments сразу разрешаем

6) 4_clear_logs убираем лишние данные из таблиц logs за 2019 и 2020 - командами truncate, сразу физическое удаление (lanmon останавливать не надо)
7) 5_clear_logs2 убираем лишние данные из таблиц logs2 за 2019 и 2020
8) сервер lanmon надо остановить 6_clear_data - удаляем лишнее из таблицы archives_restored.public.data методом: создать новую таблицу, скопировать данные, переименовать старую таблицу, переименовать новую
9) запускаем lanmon, можно дать поработать сутки, если все ок - удаляем старую таблицу (data_old)
	- Как выяснилось, можно просто очистить таблицу truncate-ом, только надо изменить функцию get_time_of_last_record - см файл get_time_of_last_record.sql

Собственно переход с pg8.3 на pg11


10) останавливае lanmon, делаем бэкапы баз (на этот раз - уже уменьшенные будут), останаваливаем pg8 на 5432
10+) на pg 11 надо создать роли:
CREATE ROLE lanmon WITH
  LOGIN
  NOSUPERUSER
  INHERIT
  NOCREATEDB
  NOCREATEROLE
  NOREPLICATION;
CREATE ROLE billing WITH
  LOGIN
  NOSUPERUSER
  INHERIT
  NOCREATEDB
  NOCREATEROLE
  NOREPLICATION;  
  
11) поднимаем бэкапы на pg11, 
12) перезапускаем pg11 на 5432
12+) для корректной работы - ALTER DATABASE "lanmon_restored" SET search_path TO public,lanmon,lanmon2 
13) запускаем lanmon сервер


20) 



на удаление будет вариант с копированием оперативных данных в отдельную таблицу, ее индексированием, удалением основной и переименованием созданной
вариант с удалением из основной влечет автовакуум и занимает 56 минут - больше, чем время экономии

100)
ALTER TABLE public.data ADD CONSTRAINT pk_data PRIMARY KEY (dt, rectypeid, devid, paramid);
